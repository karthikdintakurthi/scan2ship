#!/usr/bin/env node

/**
 * Comprehensive Credits API Test Script
 * Tests all credits-related endpoints to ensure they work correctly
 */

const http = require('http');

const BASE_URL = 'http://localhost:3000';
let authToken = null;

// Test data
const testUser = {
  email: 'test@example.com',
  password: 'test123'
};

// Helper function to make HTTP requests
function makeRequest(method, path, data = null, headers = {}) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'localhost',
      port: 3000,
      path: path,
      method: method,
      headers: {
        'Content-Type': 'application/json',
        ...headers
      }
    };

    const req = http.request(options, (res) => {
      let body = '';
      res.on('data', (chunk) => {
        body += chunk;
      });
      res.on('end', () => {
        try {
          const response = {
            statusCode: res.statusCode,
            headers: res.headers,
            body: body ? JSON.parse(body) : null
          };
          resolve(response);
        } catch (error) {
          resolve({
            statusCode: res.statusCode,
            headers: res.headers,
            body: body,
            parseError: error.message
          });
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    if (data) {
      req.write(JSON.stringify(data));
    }

    req.end();
  });
}

// Test functions
async function testLogin() {
  console.log('\nüîê Testing Login Endpoint...');
  
  try {
    const response = await makeRequest('POST', '/api/auth/login', testUser);
    
    if (response.statusCode === 200 && response.body && response.body.user) {
      console.log('‚úÖ Login successful');
      console.log(`   User ID: ${response.body.user.id}`);
      console.log(`   Client ID: ${response.body.user.clientId}`);
      
      // Extract token for subsequent tests
      if (response.body.session && response.body.session.token) {
        authToken = response.body.session.token;
        console.log('‚úÖ Auth token extracted');
      } else {
        console.log('‚ùå No auth token found in response');
      }
      
      return true;
    } else {
      console.log('‚ùå Login failed');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Login request failed:', error.message);
    return false;
  }
}

async function testCreditsWithoutAuth() {
  console.log('\nüí∞ Testing Credits Endpoint (No Auth)...');
  
  try {
    const response = await makeRequest('GET', '/api/credits');
    
    if (response.statusCode === 401 && response.body && response.body.error === 'Unauthorized') {
      console.log('‚úÖ Properly returns Unauthorized without token');
      return true;
    } else {
      console.log('‚ùå Unexpected response without auth');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Credits request failed:', error.message);
    return false;
  }
}

async function testCreditsWithAuth() {
  console.log('\nüí∞ Testing Credits Endpoint (With Auth)...');
  
  if (!authToken) {
    console.log('‚ùå No auth token available');
    return false;
  }
  
  try {
    const response = await makeRequest('GET', '/api/credits', null, {
      'Authorization': `Bearer ${authToken}`
    });
    
    if (response.statusCode === 200 && response.body && response.body.success) {
      console.log('‚úÖ Credits retrieved successfully');
      console.log(`   Balance: ${response.body.data.balance}`);
      console.log(`   Total Added: ${response.body.data.totalAdded}`);
      console.log(`   Total Used: ${response.body.data.totalUsed}`);
      return true;
    } else {
      console.log('‚ùå Failed to retrieve credits');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Credits request failed:', error.message);
    return false;
  }
}

async function testTransactionsWithoutAuth() {
  console.log('\nüìä Testing Transactions Endpoint (No Auth)...');
  
  try {
    const response = await makeRequest('GET', '/api/credits/transactions');
    
    if (response.statusCode === 401 && response.body && response.body.error === 'Unauthorized') {
      console.log('‚úÖ Properly returns Unauthorized without token');
      return true;
    } else {
      console.log('‚ùå Unexpected response without auth');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Transactions request failed:', error.message);
    return false;
  }
}

async function testTransactionsWithAuth() {
  console.log('\nüìä Testing Transactions Endpoint (With Auth)...');
  
  if (!authToken) {
    console.log('‚ùå No auth token available');
    return false;
  }
  
  try {
    const response = await makeRequest('GET', '/api/credits/transactions', null, {
      'Authorization': `Bearer ${authToken}`
    });
    
    if (response.statusCode === 200 && response.body && response.body.success) {
      console.log('‚úÖ Transactions retrieved successfully');
      console.log(`   Total transactions: ${response.body.pagination.total}`);
      console.log(`   Page: ${response.body.pagination.page}`);
      return true;
    } else {
      console.log('‚ùå Failed to retrieve transactions');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Transactions request failed:', error.message);
    return false;
  }
}

async function testVerifyPaymentWithoutAuth() {
  console.log('\nüí≥ Testing Verify Payment Endpoint (No Auth)...');
  
  try {
    const response = await makeRequest('POST', '/api/credits/verify-payment', {
      amount: 100,
      transactionRef: 'TEST123'
    });
    
    if (response.statusCode === 401 && response.body && response.body.error === 'Unauthorized') {
      console.log('‚úÖ Properly returns Unauthorized without token');
      return true;
    } else {
      console.log('‚ùå Unexpected response without auth');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Verify payment request failed:', error.message);
    return false;
  }
}

async function testVerifyPaymentWithAuth() {
  console.log('\nüí≥ Testing Verify Payment Endpoint (With Auth)...');
  
  if (!authToken) {
    console.log('‚ùå No auth token available');
    return false;
  }
  
  try {
    const response = await makeRequest('POST', '/api/credits/verify-payment', {
      amount: 100,
      transactionRef: 'TEST123'
    }, {
      'Authorization': `Bearer ${authToken}`
    });
    
    if (response.statusCode === 200 && response.body) {
      console.log('‚úÖ Verify payment endpoint working');
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return true;
    } else {
      console.log('‚ùå Verify payment failed');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Verify payment request failed:', error.message);
    return false;
  }
}

async function testInvalidToken() {
  console.log('\nüö´ Testing Invalid Token...');
  
  try {
    const response = await makeRequest('GET', '/api/credits', null, {
      'Authorization': 'Bearer invalid-token-123'
    });
    
    if (response.statusCode === 401) {
      console.log('‚úÖ Properly rejects invalid token');
      return true;
    } else {
      console.log('‚ùå Unexpected response with invalid token');
      console.log(`   Status: ${response.statusCode}`);
      console.log(`   Response: ${JSON.stringify(response.body, null, 2)}`);
      return false;
    }
  } catch (error) {
    console.log('‚ùå Invalid token test failed:', error.message);
    return false;
  }
}

// Main test runner
async function runAllTests() {
  console.log('üß™ Starting Comprehensive Credits API Tests...\n');
  
  const tests = [
    { name: 'Login', fn: testLogin },
    { name: 'Credits (No Auth)', fn: testCreditsWithoutAuth },
    { name: 'Credits (With Auth)', fn: testCreditsWithAuth },
    { name: 'Transactions (No Auth)', fn: testTransactionsWithoutAuth },
    { name: 'Transactions (With Auth)', fn: testTransactionsWithAuth },
    { name: 'Verify Payment (No Auth)', fn: testVerifyPaymentWithoutAuth },
    { name: 'Verify Payment (With Auth)', fn: testVerifyPaymentWithAuth },
    { name: 'Invalid Token', fn: testInvalidToken }
  ];
  
  let passedTests = 0;
  let totalTests = tests.length;
  
  for (const test of tests) {
    try {
      const result = await test.fn();
      if (result) {
        passedTests++;
      }
    } catch (error) {
      console.log(`‚ùå ${test.name} test crashed:`, error.message);
    }
  }
  
  // Final summary
  console.log('\n' + '='.repeat(60));
  console.log('üìä TEST RESULTS SUMMARY');
  console.log('='.repeat(60));
  console.log(`‚úÖ Passed: ${passedTests}/${totalTests}`);
  console.log(`‚ùå Failed: ${totalTests - passedTests}/${totalTests}`);
  
  if (passedTests === totalTests) {
    console.log('\nüéâ ALL TESTS PASSED! The Credits API is working perfectly!');
    console.log('\nüîí Security Features Verified:');
    console.log('   ‚Ä¢ Authentication required for protected endpoints');
    console.log('   ‚Ä¢ Proper JWT token validation');
    console.log('   ‚Ä¢ Unauthorized access properly blocked');
    console.log('   ‚Ä¢ No 500 errors or crashes');
  } else {
    console.log('\n‚ö†Ô∏è  Some tests failed. Please review the output above.');
    process.exit(1);
  }
}

// Run tests
runAllTests().catch(error => {
  console.error('‚ùå Test runner failed:', error);
  process.exit(1);
});
